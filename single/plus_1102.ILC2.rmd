---
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---


# 20211009_10x_LY sc10x               

only ILC2 in preAnno_1 selected           

```{r message=FALSE, warning=FALSE}
source("../../../analysis.10x.r")
```

## subset ILC2          

### processed obj             

```{r}
GEX.seur <- readRDS("sc10x.GEX.seur.pre1105.rds")
GEX.seur
```

```{r fig.width=12,fig.height=4.5}
DimPlot(GEX.seur, reduction = "umap", group.by = "preAnno_1",label = F, repel = F, label.size = 3.5) +
  DimPlot(GEX.seur, reduction = "umap", group.by = "preAnno_2",label = F, repel = F, label.size = 3.2)
```

### only ILC2              

```{r}
GEX.seur <- subset(GEX.seur, subset = preAnno_1=="ILC2")
GEX.seur <- subset(GEX.seur, features = rownames(GEX.seur)[rowSums(GEX.seur@assays[['RNA']]@data > 0)>=3])
GEX.seur
```

```{r fig.width=12,fig.height=4.5}
DimPlot(GEX.seur, reduction = "umap", group.by = "preAnno_1",label = F, repel = F, label.size = 3.5) +
  DimPlot(GEX.seur, reduction = "umap", group.by = "preAnno_2",label = F, repel = F, label.size = 3.2)
```

## re-clustering                 

```{r paged.print=FALSE}
# remove unwanted metadata
GEX.seur@meta.data <- GEX.seur@meta.data[,c(1:8,12,14,15:17)]
head(GEX.seur@meta.data)
```


```{r fig.width= 8, fig.height=3.2}
plota <- FeatureScatter(GEX.seur, feature1 = "nCount_RNA", feature2 = "percent.mt", group.by = "orig.ident")  + 
             coord_cartesian(xlim =c(0, 40000), ylim = c(0, 20))
plotb <- FeatureScatter(GEX.seur, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "orig.ident") + 
             coord_cartesian(xlim =c(0, 40000), ylim = c(0, 6000))
plota + plotb
```


```{r fig.height=6, message=FALSE, warning=FALSE, fig.width=15}
GEX.seur <- FindVariableFeatures(GEX.seur, selection.method = "vst", nfeatures = 1000)

# Identify the 10 most highly variable genes
#top10 <- head(VariableFeatures(GEX.seur), 10)
top40 <- head(VariableFeatures(GEX.seur), 40)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(GEX.seur)
plot2 <- LabelPoints(plot = plot1, points = top40, repel = T)
plot1 + plot2
```

```{r}
top40
```
```{r}
GEX.seur <- ScaleData(GEX.seur, features = rownames(GEX.seur))
```

### PCA       

```{r}
# exclude MT genes  
MT_gene <- grep("^mt-",rownames(GEX.seur),value = T)
GEX.seur <- RunPCA(GEX.seur, features = setdiff(VariableFeatures(object = GEX.seur),MT_gene))
```

```{r fig.width=8.2, fig.height=3.2}
DimPlot(GEX.seur, reduction = "pca",dims = 1:2, group.by = "preAnno_1") +
  DimPlot(GEX.seur, reduction = "pca",dims = 3:4, group.by = "preAnno_1")
```

```{r fig.width=8.2, fig.height=3.2}
DimPlot(GEX.seur, reduction = "pca",dims = 1:2, group.by = "preAnno_2") +
  DimPlot(GEX.seur, reduction = "pca",dims = 3:4, group.by = "preAnno_2")
```

```{r pcsheat,fig.width=9,fig.height=12}
DimHeatmap(GEX.seur, dims = 1:24, cells = 1500, balanced = TRUE,ncol = 4)
```

##### decide PCs to use          
     
```{r}
ElbowPlot(GEX.seur,ndims = 30)
```
would take PCs 1-15 for next  

```{r}
PCs <- 1:15
GEX.seur <- FindNeighbors(GEX.seur, dims = PCs, k.param = 80)
GEX.seur <- FindClusters(GEX.seur,  resolution = 0.6, method = 'igraph')
```

```{r}
#GEX.seur <- RunTSNE(GEX.seur, dims=PCs, max_iter = 8000)    # using this one
GEX.seur <- RunUMAP(GEX.seur, dims=PCs, n.neighbors = 80)    # using this one
```

```{r eval=FALSE, include=FALSE}
saveRDS(GEX.seur, "sc10_plus.GEX.seur_ILC2.afterTSNE.rds")
```

```{r include=FALSE}
GEX.seur <- readRDS("sc10_plus.GEX.seur_ILC2.afterTSNE.rds")
```

```{r eval=FALSE, include=FALSE, paged.print=FALSE}
head(GEX.seur@meta.data)
```

```{r fig.width=9.2,fig.height=3.2}
DimPlot(GEX.seur, reduction = "tsne", label = T) + DimPlot(GEX.seur, reduction = "umap", label = T)
```

```{r fig.width=9.2,fig.height=3.2}
DimPlot(GEX.seur, reduction = "tsne", label = T, group.by = "preAnno_2") + DimPlot(GEX.seur, reduction = "umap", label = T, group.by = "preAnno_2")
```

```{r  fig.width=9.2,fig.height=3.2}
DimPlot(GEX.seur, reduction = "umap", group.by = "DoubletFinder0.05") +
  DimPlot(GEX.seur, reduction = "umap", group.by = "DoubletFinder0.1")
```

### check markers            


```{r fig.width=4.8, fig.height=5.6}
# Thy1: CD90
# Il7r: IL-7Ra
genes_to_check <- c("Fcer1g","Klrb1c","Ncr1","Il22",
                    "Ccr6","Tbx21","Ifng","Eomes",
                    "Gata3","Il1rl1","Il13","Il17a",
                    "Il4","Il5","Klrg1","Rorc",
                    "Il7r","Thy1","Kdm6b","Ptprc",
                    "Cd3d","Cd3g","Cd4","Cd8a",
                    "Trac","Trdc","Epcam","Pecam1","Siglech",
                    "Hist1h1b","Top2a","Mcm6","Mki67")

DotPlot(GEX.seur, features = genes_to_check[genes_to_check %in% rownames(GEX.seur)],
             assay='RNA' , group.by = "seurat_clusters" )  + coord_flip()
```

```{r fig.width=4.5, fig.height=3.6}
# 
genes_nature2017 <- c("Tbx21","Ifng","Ccl5","Il12rb1",
                      "Gata3","Il1rl1","Il5","Il13",
                      "Rorc","Il17a","Ahr","Il23r")

DotPlot(GEX.seur, features = genes_nature2017[genes_nature2017 %in% rownames(GEX.seur)],
             assay='RNA' , group.by = "seurat_clusters" )  + coord_flip()
```

```{r fig.height=17.5, fig.width=12}
FeaturePlot(GEX.seur, features = genes_to_check, ncol = 4)
```

```{r fig.height=6.5, fig.width=12}
FeaturePlot(GEX.seur, features = genes_nature2017, ncol = 4)
```

### find markers          

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
# find markers for every cluster compared to all remaining cells, report only the positive ones
GEX.markers.ILC2_pre <- FindAllMarkers(GEX.seur, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.1,
                                  test.use = "MAST")
GEX.markers.ILC2_pre <- read.table("GEX.markers.ILC2_pre.1108.csv", header = TRUE, sep = ",")

#GEX.markers.ILC2_pre <- GEX.markers.ILC2_pre %>% arrange(gene,p_val_adj)
#GEX.markers.ILC2_pre <- GEX.markers.ILC2_pre[!duplicated(GEX.markers.ILC2_pre$gene),]
#GEX.markers.ILC2_pre <- GEX.markers.ILC2_pre %>% arrange(cluster,desc(avg_log2FC))

GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 16, wt = avg_log2FC)

#GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(pct.1 > 0.2 & pct.2 <0.1) %>% top_n(n = 8, wt = avg_log2FC)
#GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(gene %in% c("Top2a","Mki67") )
```

```{r eval=FALSE, include=FALSE}
write.table(GEX.markers.ILC2_pre, 
            "GEX.markers.ILC2_pre.1108.csv", 
            col.names = TRUE,
            row.names = FALSE,
            quote = F,
            sep = ",")
```


```{r fig.width=12,fig.height=36}
FeaturePlot(GEX.seur, features = (GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 16, wt = avg_log2FC))$gene[1:64],
            reduction = 'umap')
```

```{r fig.width=12,fig.height=27}
FeaturePlot(GEX.seur, features = (GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 16, wt = avg_log2FC))$gene[65:112],
            reduction = 'umap')
```

```{r fig.width=12,fig.height=36}
VlnPlot(GEX.seur, features = (GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 16, wt = avg_log2FC))$gene[1:64])
```

```{r fig.width=12,fig.height=27}
VlnPlot(GEX.seur, features = (GEX.markers.ILC2_pre %>% group_by(cluster) %>% top_n(n = 16, wt = avg_log2FC))$gene[65:112])
```

%>% filter(pct.1 > 0.3 & pct.2 <pct.1)

```{r fig.width=12, fig.height=12}
GEX.seur$seurat_clusters <- factor(as.character(GEX.seur$seurat_clusters),
                                   levels = c(0,5,1,4,2,3,6))
marker.new <- c((GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==0))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==5))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==1))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==4))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==2))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==3))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 16, wt = avg_log2FC) %>% filter(cluster==6))$gene)
p.heat_top16 <- DoHeatmap(GEX.seur , group.by = "seurat_clusters", 
             features = marker.new) +
             NoLegend() + labs(title = "ILC2_newclusters top16\n")
p.heat_top16
```

```{r fig.width=12, fig.height=12}
marker.new <- c((GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==0))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==5))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==1))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==4))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==2))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==3))$gene,
                (GEX.markers.ILC2_pre %>% group_by(cluster) %>% filter(avg_log2FC >0.3) %>% top_n(n = 80, wt = avg_log2FC) %>% filter(cluster==6))$gene)
p.heat_top80 <- DoHeatmap(GEX.seur , group.by = "seurat_clusters", 
             features = marker.new) +
             NoLegend() + labs(title = "ILC2_newclusters top80\n")+ theme( text = element_text( size = 4 ))
p.heat_top80
```

```{r eval=FALSE, include=FALSE}
ggsave("Doheatmap.ILC2newclusters_top16.pdf",
       plot = p.heat_top16,
       width = 12,
       height = 12)
ggsave("Doheatmap.ILC2newclusters_top80.pdf",
       plot = p.heat_top80,
       width = 12,
       height = 12)
```


##### might be not easy to quickly get accurate ILC2 clusters, which might be 4-8                
##### next would check condition markers(DEGs), then run topic model                         


## condition markers                


### DEGs              

```{r message=TRUE, warning=TRUE, include=FALSE}
# find DEGs in all clusters for 'cKO vs CTL'
GEX.seur$ILC2_preAnno <- factor(paste0("ILC2_",as.character(GEX.seur$seurat_clusters)),
                                levels = paste0("ILC2_",levels(GEX.seur$seurat_clusters)))

Idents(GEX.seur) <- "SP.info"

names_preA1 <- levels(GEX.seur$ILC2_preAnno)
#GEX.DEGs_preA1 <- list()
#for(nn in names_preA1){
#  GEX.DEGs_preA1[[nn]] <- FindAllMarkers(subset(GEX.seur, subset = ILC2_preAnno == nn),
#                                         only.pos = TRUE, 
#                                         min.pct = 0.1, 
#                                         logfc.threshold = 0.25,
#                                         test.use = "MAST")
#}
#for(nn in names_preA1){
#  GEX.DEGs_preA1[[nn]]$ILC2_preAnno <- nn
#}

GEX.DEGs_preA1 <- readRDS("GEX.DEGs.ILC2_preAnno.rds")
```

```{r eval=FALSE, include=FALSE}
# save DEG result
saveRDS(GEX.DEGs_preA1, "GEX.DEGs.ILC2_preAnno.rds")

# save as datafrmae
GEX.DEGs_preA1.df <- data.frame()
for(nn in names_preA1){
  GEX.DEGs_preA1.df <- rbind(GEX.DEGs_preA1.df,GEX.DEGs_preA1[[nn]])
}
#GEX.DEGs_preA1.df
write.table(data.frame(gene=rownames(GEX.DEGs_preA1.df),
                       GEX.DEGs_preA1.df), "GEX.DEGs.ILC2_preAnno.csv", col.names = T, row.names = F, quote = F, sep = ",")

```



```{r}
lapply(GEX.DEGs_preA1,head)
```
```{r}
lapply(GEX.DEGs_preA1,dim)
``` 

```{r message=TRUE, warning=TRUE}
vln_DEGs.preA1 <- list()
for(nn in names_preA1){
  pp.test <- VlnPlot(subset(GEX.seur, subset = ILC2_preAnno == nn), 
               features = (GEX.DEGs_preA1[[nn]] %>% group_by(cluster) %>% top_n(n = 8, wt = avg_log2FC))$gene[1:48],
               combine = F)
  title <- cowplot::ggdraw() + cowplot::draw_label(nn, fontface = 'bold', size = 9)
  for(pp in 1:length(pp.test)){
    pp.test[[pp]] <- pp.test[[pp]] + NoLegend()
  }
  vln_DEGs.preA1[[nn]] <- cowplot::plot_grid(title = title,plotlist =  pp.test, ncol = 4)
}
```

##### top 8 vlnplot           

```{r echo=FALSE, fig.height=15, fig.width=8}
vln_DEGs.preA1
```



### cell composition                    

#### FB.info      

```{r}
Idents(GEX.seur) <- "ILC2_preAnno"
```


```{r fig.width=12,fig.height=4.5}
DimPlot(GEX.seur, reduction = "umap", label = F,group.by = "FB.info",
        cols = c("#05BE78","#5ECDF2","#739BDD","#B7E16F","#87C0C9","#7756FA","#9855B9","#6F9920"))+
  DimPlot(GEX.seur, reduction = "umap", label = T)
```

```{r fig.width=12,fig.height=6}
DimPlot(GEX.seur, group.by = "FB.info", split.by = "FB.info", ncol = 4,
        cols = c("#05BE78","#5ECDF2","#739BDD","#B7E16F","#87C0C9","#7756FA","#9855B9","#6F9920"))
```

```{r}
#GEX.seur$FB.info <- as.factor(as.character(GEX.seur$FB.info))
#GEX.seur$ILC2_preAnno <- as.factor(as.character(GEX.seur$ILC2_preAnno))
table(data.frame(GEX.seur$FB.info,GEX.seur$ILC2_preAnno))
```

```{r fig.width=5, fig.height=3}
pheatmap::pheatmap(table(data.frame(GEX.seur$FB.info,GEX.seur$ILC2_preAnno)),
                   main = "Cell Count",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f")
```

```{r fig.width=5, fig.height=3}
pheatmap::pheatmap(100*rowRatio(table(data.frame(GEX.seur$FB.info,GEX.seur$ILC2_preAnno))),
                   main = "Percentage of Sample count(row)",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.2f")
```

#### SP.info        

```{r fig.width=12,fig.height=4.5}
DimPlot(GEX.seur, reduction = "umap", label = F,group.by = "SP.info")+
  DimPlot(GEX.seur, reduction = "umap", label = T)
```

```{r fig.width=12,fig.height=4.5}
DimPlot(GEX.seur, reduction = "umap", label = F,group.by = "SP.info")+
  DimPlot(GEX.seur, reduction = "umap", label = T, group.by = "ILC2_preAnno")
```

```{r fig.width=12.6,fig.height=4.5}
DimPlot(GEX.seur, group.by = "SP.info", split.by = "SP.info", ncol = 3)
```

```{r}
table(data.frame(GEX.seur$SP.info,GEX.seur$ILC2_preAnno))
```

```{r fig.width=5, fig.height=2}
pheatmap::pheatmap(table(data.frame(GEX.seur$SP.info,GEX.seur$ILC2_preAnno)),
                   main = "Cell Count",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f")
```

```{r fig.width=5, fig.height=2}
pheatmap::pheatmap(100*rowRatio(table(data.frame(GEX.seur$SP.info,GEX.seur$ILC2_preAnno))),
                   main = "Percentage of Sample count(row)",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.2f")
```


#### stat without tag3            

```{r}
GEX.seur
```


```{r}
GEX.seur_notag3 <- subset(GEX.seur, cells= colnames(GEX.seur)[GEX.seur$FB.info != "hashtag3"])
GEX.seur_notag3
```

```{r}
table(data.frame(GEX.seur_notag3$SP.info,GEX.seur_notag3$ILC2_preAnno))
```

```{r fig.width=5, fig.height=2}
pheatmap::pheatmap(table(data.frame(GEX.seur_notag3$SP.info,GEX.seur_notag3$ILC2_preAnno)),
                   main = "Cell Count (no tag3)",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.0f")
```

```{r fig.width=5, fig.height=2}
pheatmap::pheatmap(100*rowRatio(table(data.frame(GEX.seur_notag3$SP.info,GEX.seur_notag3$ILC2_preAnno))),
                   main = "Percentage of Sample count(row) (no tag3)",
                   cluster_rows = F, cluster_cols = F, display_numbers = T, number_format = "%.2f")
```





## topic model               

basically follow https://bitbucket.org/jerry00/mouse_small_intestine_immune_cell_atlas/src/master/script/topicModeling_PP.R               

```{r}
source("topicmodel.r")
```


### calculate topics               
               
```{r}
# using umap coordinates
GEX.seur@reductions[['umap']]@cell.embeddings[1:5,1:2]
```


```{r}
# to exclude ribosomal
ribo.loc <- grepl("Rpl|Rps", rownames(GEX.seur@assays[['RNA']]@counts))
head(rownames(GEX.seur@assays[['RNA']]@counts)[ribo.loc])
sum(ribo.loc)
```

```{r}
# Build topic models and generate assocaited figures 
# Recommended to build models for k = 4,6,8,10,12,14,16,18,20,22 and tolerance 0.1 (set as inputs to this function)
# each K would take hours, bigger K, longer time
# so slow, would run into three sub-scripts from 6 to 22
#for(kk in c(4,6,8,10,12,14,16,18,20,22)){
#  kkk <- kk
#  if(kk %in% c(4,6,8)){
#    kkk <- paste0(0,kk)
#  }
#  FitGoM(t(as.matrix(GEX.seur@assays[['RNA']]@counts)[!ribo.loc,]),
#         K = kk, tol = 0.1,
#         path_rda =paste0("topicmodel/test_topic.n",kkk,"_t0.1.rda"))
#}
```


```{r}
# after topic models are done, ranged K, 
# here could directly load the saved object
# the default var is 'Topic_clus'
load("topicmodel/test_topic.n10_t0.1.rda")
```


```{r}
omega <- as.data.frame(Topic_clus$omega)
colnames(omega) <- paste0("Topic_", colnames(omega))
GEX.seur <- AddMetaData(GEX.seur, omega)
```


```{r}
head(GEX.seur@meta.data)
```


### plot                


##### plot, for better visualization and only for visualization, set outliers as max inliers.            

```{r}
tk <- 1+0
tp <- paste0("Topic_",1:tk)
outlier <- lapply(tp, function(x) which(GEX.seur@meta.data[,x]>(mean(GEX.seur@meta.data[,x], na.rm=TRUE)+
                                                                  3*sd(GEX.seur@meta.data[,x], na.rm=TRUE))))
names(outlier) <- tp
#
max.nooutlier <- lapply(tp, function(x) if(length(unlist(outlier[x]))){
                                          ceiling(10*max(GEX.seur@meta.data[-unlist(outlier[x]),x], na.rm=TRUE))/10  
                                        }else{
                                          ceiling(10*max(GEX.seur@meta.data[,x], na.rm=TRUE))/10
                                        })
names(max.nooutlier) <- tp
```

##### build a new seurat object to apply the change      

```{r}
GEX.seur_override <- GEX.seur
for(xx in tp){
  GEX.seur_override@meta.data[unlist(outlier[xx]),xx] <- rep(unlist(max.nooutlier[xx]))
}
```


#### tsne/umap              

##### generate list of tSNE plots        

```{r}
p <- lapply(tp, function(x) plot.tsne.feature(GEX.seur_override,
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p
```


```{r}
p_umap <- lapply(tp, function(x) plot.umap.feature(GEX.seur_override,
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```

#### separate conditions              

still in umap              
         
#### PBS
```{r}
p_umap.PBS <- lapply(tp, function(x) plot.umap.feature(subset(GEX.seur_override, subset=SP.info=="PBS"),
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap.PBS
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap.PBS, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.onlyPBS.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap.PBS, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```


#### IL33
```{r}
p_umap.IL33 <- lapply(tp, function(x) plot.umap.feature(subset(GEX.seur_override, subset=SP.info=="IL-33"),
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap.IL33
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap.IL33, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.onlyIL33.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap.IL33, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```

#### IL33_DA
```{r}
p_umap.IL33_DA <- lapply(tp, function(x) plot.umap.feature(subset(GEX.seur_override, subset=SP.info=="IL-33_DA"),
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap.IL33_DA
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap.IL33_DA, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.onlyIL33_DA.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap.IL33_DA, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```

#### no tag3           

##### all cells without tag3           
```{r}
p_umap.notag3 <- lapply(tp, function(x) plot.umap.feature(subset(GEX.seur_override, subset=FB.info!="hashtag3"),
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap.notag3
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap.notag3, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.notag3.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap.notag3, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```


##### IL33 without tag3           

```{r}
p_umap.IL33_notag3 <- lapply(tp, function(x) plot.umap.feature(subset(GEX.seur_override, subset=(SP.info=="IL-33" & FB.info!="hashtag3")),
                                              x,
                                              "meta",
                                              pt.size = 0.5,
                                              ncols = 1,
                                              title = "weight",
                                              lower = 0,
                                              upper = unlist(max.nooutlier[x]),
                                              na.color = "gray"))
p_umap.IL33_notag3
```


```{r fig.width=9,fig.height=6}
cowplot::plot_grid(plotlist = p_umap.IL33_notag3, ncol = 4)
```

```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_on_UMAP_k",tk,"_tol0.1.onlyIL33_notag3.pdf"),
       plot=cowplot::plot_grid(plotlist = p_umap.IL33_notag3, ncol = 4),
       device = 'pdf',
       width = 9,
       height = 6)
```



#### topic score          

##### collect gene scores for each topic      
```{r}
theta <- as.data.frame(Topic_clus$theta)
colnames(theta) <- paste0("Topic_", 1:tk)

feat.topic <- ExtractTopFeatures(theta, top_features = 50)

feat.topic_genes <- as.data.frame(sapply(1:tk, function(x) rownames(theta)[feat.topic$indices[x,]]))
colnames(feat.topic_genes) <- paste0("topic_", 1:tk)

feat.topic_scores <- as.data.frame(feat.topic$scores)
rownames(feat.topic_scores) <- paste0("topic_", 1:tk)
```

```{r eval=FALSE, include=FALSE}
write.csv(feat.topic_genes,
          paste0("topicmodel/K",tk,"/top50features_k",tk,"_tol0.1.csv"),
          row.names = FALSE)
```


#### topic top genes          

##### visualize the top 40 genes of each topic      

```{r}
plot.feat.topic <- data.frame()
for(j in 1:nrow(feat.topic_scores)){
  current.topic <- as.data.frame(t(feat.topic_scores[j,]))
  colnames(current.topic) <- "score"
  rownames(current.topic) <- feat.topic_genes[,j]
  current.topic$genes <- feat.topic_genes[,j]
  current.topic.top <- current.topic[1:40,]
  current.topic.top$topic <- rep(colnames(feat.topic_genes)[j], nrow(current.topic.top))
  current.topic.top$genes <- factor(current.topic.top$genes, levels=rev(current.topic.top$genes))
  current.topic.top$order <- paste0(current.topic.top$genes, "_", current.topic.top$topic)
  current.topic.top$order <- factor(current.topic.top$order, levels=rev(current.topic.top$order))
  
  plot.feat.topic <- rbind(plot.feat.topic, current.topic.top)
}

plot.feat.topic$topic <- factor(plot.feat.topic$topic, levels=unique(plot.feat.topic$topic))
```

bar plots       
```{r topic_2,fig.width=8,fig.height=9.6}
p_bar <- ggplot(data = plot.feat.topic, aes(x = order, y = score)) +
           geom_bar(stat = "identity") +
           coord_flip() +
           theme(axis.text.x = element_text(angle = 45, hjust = 1),
                 axis.text = element_text(size = 5), text = element_text(size = 8),
                 axis.line = element_line(colour = "black"),
                 panel.grid.major = element_blank(),
                 panel.grid.minor = element_blank(),
                 panel.border = element_blank(),
                 panel.background = element_blank()) +
           facet_wrap(~topic, scales="free", ncol = 4) +
           scale_x_discrete(breaks = plot.feat.topic$order, labels = plot.feat.topic$genes)
  
p_bar        
```


```{r eval=FALSE, include=FALSE}
ggsave(paste0("topicmodel/K",tk,"/topics_bar_k",tk,"_tol0.1.pdf"),
       plot=p_bar,
       device = 'pdf',
       width = 8,
       height = 9.6)
```

plot expression of top 40 genes        
```{r}
topic.genes <- lapply(tolower(tp), function(x) plot.feat.topic$genes[which(plot.feat.topic$topic==x)])
names(topic.genes) <- tolower(tp)

for(t in 1:tk){
  p_genes <- lapply(unlist(topic.genes[t]), function(y) plot.umap.feature(GEX.seur, y, "gene",
                                                                          pt.size = 0.5,
                                                                          ncols = 1, title = "expression"))
  # arrange plots on a grid
  cowplot::plot_grid(plotlist=p_genes, ncol=4)
  
  # ggsave
  ggsave(paste0("topicmodel/K",tk,"/topics_top40_expression_on_UMAP_",tp[t],"_k",tk,"_tol0.1.pdf"),
         width = 13, height = 26, units = "in")
}
```


### clusters vs topics            

#### all cells      

```{r fig.width=4.5, fig.height=3.5}
## code from Dianyu's github
#    https://github.com/chendianyu/2021_NI_scGCB
## Connect clustering and topic model
cluster_topic_mtx <- GEX.seur_override@meta.data %>% 
    #filter(seurat_clusters != 6) %>% 
    gather(key = "topic", value = "weight", paste0("Topic_", 1:10), factor_key = T) %>%
    group_by(ILC2_preAnno, topic) %>% 
    summarise(weight = mean(weight)) %>%
    spread(key = topic, value = weight) 
cluster_topic_mtx <- column_to_rownames(cluster_topic_mtx, var = "ILC2_preAnno") 
topic_order <- order(max.col(t(apply(cluster_topic_mtx, 2, scale))))
pheatmap::pheatmap(t(cluster_topic_mtx)[c(8,7,3,6,10,4,5,9,2,1), c(1,5,2:4,6,7)],
         cluster_rows = F,
         cluster_cols = F,
         scale = "row",
         main= "Relation of Topics and Clusters")
```

```{r eval=FALSE, include=FALSE}
pdf(paste0("topicmodel/K",tk,"/topics_clusters_heatmap_K",tk,"_tol0.1.pdf"),
    width = 4.5,
    height = 3.5)
pheatmap::pheatmap(t(cluster_topic_mtx)[c(8,7,3,6,10,4,5,9,2,1), c(1,5,2:4,6,7)],
         cluster_rows = F,
         cluster_cols = F,
         scale = "row",
         main= "Relation of Topics and Clusters")
dev.off()
```


#### no tag3      

```{r fig.width=4.5, fig.height=3.5}
## code from Dianyu's github
#    https://github.com/chendianyu/2021_NI_scGCB
## Connect clustering and topic model
cluster_topic_mtx <- GEX.seur_override@meta.data %>% 
    filter(FB.info != "hashtag3") %>% 
    gather(key = "topic", value = "weight", paste0("Topic_", 1:10), factor_key = T) %>%
    group_by(ILC2_preAnno, topic) %>% 
    summarise(weight = mean(weight)) %>%
    spread(key = topic, value = weight) 
cluster_topic_mtx <- column_to_rownames(cluster_topic_mtx, var = "ILC2_preAnno") 
topic_order <- order(max.col(t(apply(cluster_topic_mtx, 2, scale))))
pheatmap::pheatmap(t(cluster_topic_mtx)[c(8,7,3,6,10,4,5,9,2,1), c(1,5,2:4,6,7)],
         cluster_rows = F,
         cluster_cols = F,
         scale = "row",
         main= "Relation of Topics and Clusters (notag3)")
```

```{r eval=FALSE, include=FALSE}
pdf(paste0("topicmodel/K",tk,"/topics_clusters_heatmap_K",tk,"_tol0.1.notag3.pdf"),
    width = 4.5,
    height = 3.5)
pheatmap::pheatmap(t(cluster_topic_mtx)[c(8,7,3,6,10,4,5,9,2,1), c(1,5,2:4,6,7)],
         cluster_rows = F,
         cluster_cols = F,
         scale = "row",
         main= "Relation of Topics and Clusters (notag3)")
dev.off()
```


### compare phenotypes                  


```{r}
#### subset Seurat object for condtions
## PBS
topic.avg.PBS <- sapply(tp, function(x){
  mean(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="PBS",x])
})
names(topic.avg.PBS) <- tp

## IL33
topic.avg.IL33 <- sapply(tp, function(x){
  mean(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33",x])
})
names(topic.avg.IL33) <- tp

## IL33_DA
topic.avg.IL33_DA <- sapply(tp, function(x){
  mean(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33_DA",x])
})
names(topic.avg.IL33_DA) <- tp

## combine
topic.avg.all <- rbind(topic.avg.PBS,topic.avg.IL33,topic.avg.IL33_DA)
rownames(topic.avg.all) <- c("PBS","IL33","IL33_DA")
```


```{r}
####
topic.avg.PBS
topic.avg.IL33
topic.avg.IL33_DA
topic.avg.all
```


#### plot          
           
```{r}
gp.list.box <- list()
gp.list.avg <- list()
gp.list.cum <- list()


for(top in tp){
  
  topic.data <- data.frame(weight = c(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="PBS",top],
                                      GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33",top],
                                      GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33_DA",top]),
                           condition = c(rep("PBS", length(which(GEX.seur_override$SP.info=="PBS"))),
                                         rep("IL33", length(which(GEX.seur_override$SP.info=="IL-33"))),
                                         rep("IL33_DA", length(which(GEX.seur_override$SP.info=="IL-33_DA")))),
                           topic = rep(top, nrow(GEX.seur_override@meta.data)))
  topic.data$condition <- factor(topic.data$condition, levels = c("PBS","IL33","IL33_DA"))
  
  gp.list.box[[top]] <- ggplot(topic.data, aes(y=weight, x=condition)) +
                    geom_boxplot() + scale_y_continuous(limits=c(0,max.nooutlier[[top]])) +
                    facet_wrap(~ topic, ncol=1)    
  
  avg.data <- as.data.frame(topic.avg.all[,top])
  avg.data$topic <- rep(top, nrow(avg.data))
  colnames(avg.data) <- c("average", "topic")
  
  
  gp.list.avg[[top]] <- ggplot(avg.data, aes(x=factor(rownames(avg.data),levels = c("PBS","IL33","IL33_DA")),
                                                      y=average)) +
                   geom_col() + xlab('') +
                   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                   facet_wrap(~ topic, ncol = 1)
  
  gp.list.cum[[top]] <- ggplot(topic.data, aes(x=weight, color=condition)) +
                   stat_ecdf(geom="step", size = 1) +
                   scale_color_manual(values = c("#191970", "#CD0000","#FF8000")) + 
                   facet_wrap(~ topic, ncol=1)
  
}

```



```{r fig.width=9, fig.height=6}
cowplot::plot_grid(plotlist=gp.list.box, ncol=4)
```

```{r fig.width=9, fig.height=6}
cowplot::plot_grid(plotlist=gp.list.avg, ncol=4)
```

```{r fig.width=15, fig.height=9}
cowplot::plot_grid(plotlist=gp.list.cum, ncol=4)
```

```{r eval=FALSE, include=FALSE}
# save plot
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_boxplot_K",tk,"_tol0.1.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.box, ncol=4),
       width = 9,
       height = 6)
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_avg_K",tk,"_tol0.1.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.avg, ncol=4),
       width = 9,
       height = 6)
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_cumdist_K",tk,"_tol0.1.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.cum, ncol=4),
       width = 15,
       height = 9)

```



#### compute p-values          
          
between each two conditions            


```{r}
# PBS vs IL33
p.PBS_vs_IL33.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="PBS",x],
              GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33",x])
})
names(p.PBS_vs_IL33.wilcox) <- tp
pmat.PBS_vs_IL33.wilcox <- sapply(tp, function(x) p.PBS_vs_IL33.wilcox[[x]]$p.value)


# PBS vs IL33_DA
p.PBS_vs_IL33DA.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="PBS",x],
              GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33_DA",x])
})
names(p.PBS_vs_IL33DA.wilcox) <- tp
pmat.PBS_vs_IL33DA.wilcox <- sapply(tp, function(x) p.PBS_vs_IL33DA.wilcox[[x]]$p.value)


# IL33 vs IL33_DA
p.IL33DA_vs_IL33.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33_DA",x],
              GEX.seur_override@meta.data[GEX.seur_override$SP.info=="IL-33",x])
})
names(p.IL33DA_vs_IL33.wilcox) <- tp
pmat.IL33DA_vs_IL33.wilcox <- sapply(tp, function(x) p.IL33DA_vs_IL33.wilcox[[x]]$p.value)


# combine pvalue
pval.conditions.wilcox <- data.frame(PBS_vs_IL33= pmat.PBS_vs_IL33.wilcox ,
                                     PBS_vs_IL33DA= pmat.PBS_vs_IL33DA.wilcox ,
                                     IL33_vs_IL33DA= pmat.IL33DA_vs_IL33.wilcox)

# combine padjust
padj.conditions.wilcox <- data.frame(PBS_vs_IL33= p.adjust(pmat.PBS_vs_IL33.wilcox,method = "BH"),
                                     PBS_vs_IL33DA= p.adjust(pmat.PBS_vs_IL33DA.wilcox,method = "BH"),
                                     IL33_vs_IL33DA= p.adjust(pmat.IL33DA_vs_IL33.wilcox,method = "BH"))

pmerge.conditions.wilcox <- cbind(pval.conditions.wilcox,padj.conditions.wilcox)
colnames(pmerge.conditions.wilcox) <- c(paste0(colnames(pval.conditions.wilcox),".pval"),
                                        paste0(colnames(padj.conditions.wilcox),".padj"))
```


```{r}
pval.conditions.wilcox
```

```{r}
padj.conditions.wilcox
```

```{r}
pmerge.conditions.wilcox
```


```{r eval=FALSE, include=FALSE}
write.csv(pmerge.conditions.wilcox, paste0("topicmodel/K",tk,"/comparison/p.values_WILCOXON-TEST__K",tk,"_tol0.1.csv"))
          
```


### compare, notag3              

```{r}
GEX.seur_override.notag3 <- subset(GEX.seur_override, subset= FB.info!="hashtag3")
```


```{r}
#### subset Seurat object for condtions
## PBS
topic.avg.PBS <- sapply(tp, function(x){
  mean(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="PBS",x])
})
names(topic.avg.PBS) <- tp

## IL33
topic.avg.IL33 <- sapply(tp, function(x){
  mean(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33",x])
})
names(topic.avg.IL33) <- tp

## IL33_DA
topic.avg.IL33_DA <- sapply(tp, function(x){
  mean(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33_DA",x])
})
names(topic.avg.IL33_DA) <- tp

## combine
topic.avg.all <- rbind(topic.avg.PBS,topic.avg.IL33,topic.avg.IL33_DA)
rownames(topic.avg.all) <- c("PBS","IL33","IL33_DA")
```


```{r}
####
topic.avg.PBS
topic.avg.IL33
topic.avg.IL33_DA
topic.avg.all
```


#### plot          
           
```{r}
gp.list.box <- list()
gp.list.avg <- list()
gp.list.cum <- list()


for(top in tp){
  
  topic.data <- data.frame(weight = c(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="PBS",top],
                                      GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33",top],
                                      GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33_DA",top]),
                           condition = c(rep("PBS", length(which(GEX.seur_override.notag3$SP.info=="PBS"))),
                                         rep("IL33", length(which(GEX.seur_override.notag3$SP.info=="IL-33"))),
                                         rep("IL33_DA", length(which(GEX.seur_override.notag3$SP.info=="IL-33_DA")))),
                           topic = rep(top, nrow(GEX.seur_override.notag3@meta.data)))
  topic.data$condition <- factor(topic.data$condition, levels = c("PBS","IL33","IL33_DA"))
  
  gp.list.box[[top]] <- ggplot(topic.data, aes(y=weight, x=condition)) +
                    geom_boxplot() + scale_y_continuous(limits=c(0,max.nooutlier[[top]])) +
                    facet_wrap(~ topic, ncol=1)    
  
  avg.data <- as.data.frame(topic.avg.all[,top])
  avg.data$topic <- rep(top, nrow(avg.data))
  colnames(avg.data) <- c("average", "topic")
  
  
  gp.list.avg[[top]] <- ggplot(avg.data, aes(x=factor(rownames(avg.data),levels = c("PBS","IL33","IL33_DA")),
                                                      y=average)) +
                   geom_col() + xlab('') +
                   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                   facet_wrap(~ topic, ncol = 1)
  
  gp.list.cum[[top]] <- ggplot(topic.data, aes(x=weight, color=condition)) +
                   stat_ecdf(geom="step", size = 1) +
                   scale_color_manual(values = c("#191970", "#CD0000","#FF8000")) + 
                   facet_wrap(~ topic, ncol=1)
  
}

```



```{r fig.width=9, fig.height=6}
cowplot::plot_grid(plotlist=gp.list.box, ncol=4)
```

```{r fig.width=9, fig.height=6}
cowplot::plot_grid(plotlist=gp.list.avg, ncol=4)
```

```{r fig.width=15, fig.height=9}
cowplot::plot_grid(plotlist=gp.list.cum, ncol=4)
```

```{r eval=FALSE, include=FALSE}
# save plot
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_boxplot_K",tk,"_tol0.1.notag3.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.box, ncol=4),
       width = 9,
       height = 6)
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_avg_K",tk,"_tol0.1.notag3.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.avg, ncol=4),
       width = 9,
       height = 6)
ggsave(paste0("topicmodel/K",tk,"/comparison/comparison_cumdist_K",tk,"_tol0.1.notag3.pdf"),
       plot = cowplot::plot_grid(plotlist=gp.list.cum, ncol=4),
       width = 15,
       height = 9)

```



#### compute p-values          
          
between each two conditions            


```{r}
# PBS vs IL33
p.PBS_vs_IL33.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="PBS",x],
              GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33",x])
})
names(p.PBS_vs_IL33.wilcox) <- tp
pmat.PBS_vs_IL33.wilcox <- sapply(tp, function(x) p.PBS_vs_IL33.wilcox[[x]]$p.value)


# PBS vs IL33_DA
p.PBS_vs_IL33DA.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="PBS",x],
              GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33_DA",x])
})
names(p.PBS_vs_IL33DA.wilcox) <- tp
pmat.PBS_vs_IL33DA.wilcox <- sapply(tp, function(x) p.PBS_vs_IL33DA.wilcox[[x]]$p.value)


# IL33 vs IL33_DA
p.IL33DA_vs_IL33.wilcox <- lapply(tp, function(x){
  wilcox.test(GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33_DA",x],
              GEX.seur_override.notag3@meta.data[GEX.seur_override.notag3$SP.info=="IL-33",x])
})
names(p.IL33DA_vs_IL33.wilcox) <- tp
pmat.IL33DA_vs_IL33.wilcox <- sapply(tp, function(x) p.IL33DA_vs_IL33.wilcox[[x]]$p.value)


# combine pvalue
pval.conditions.wilcox <- data.frame(PBS_vs_IL33= pmat.PBS_vs_IL33.wilcox ,
                                     PBS_vs_IL33DA= pmat.PBS_vs_IL33DA.wilcox ,
                                     IL33_vs_IL33DA= pmat.IL33DA_vs_IL33.wilcox)

# combine padjust
padj.conditions.wilcox <- data.frame(PBS_vs_IL33= p.adjust(pmat.PBS_vs_IL33.wilcox,method = "BH"),
                                     PBS_vs_IL33DA= p.adjust(pmat.PBS_vs_IL33DA.wilcox,method = "BH"),
                                     IL33_vs_IL33DA= p.adjust(pmat.IL33DA_vs_IL33.wilcox,method = "BH"))

pmerge.conditions.wilcox <- cbind(pval.conditions.wilcox,padj.conditions.wilcox)
colnames(pmerge.conditions.wilcox) <- c(paste0(colnames(pval.conditions.wilcox),".pval"),
                                        paste0(colnames(padj.conditions.wilcox),".padj"))
```


```{r}
pval.conditions.wilcox
```

```{r}
padj.conditions.wilcox
```

```{r}
pmerge.conditions.wilcox
```


```{r eval=FALSE, include=FALSE}
write.csv(pmerge.conditions.wilcox, paste0("topicmodel/K",tk,"/comparison/p.values_WILCOXON-TEST__K",tk,"_tol0.1.notag3.csv"))
          
```






























